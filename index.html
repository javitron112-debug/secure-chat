<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureP2P v2.2 - Security Fixed</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; connect-src 'self' wss: https:; img-src 'self' data: blob:;">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-in { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .fingerprint-box { font-family: 'Courier New', monospace; letter-spacing: 2px; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex items-center justify-center p-4 font-sans text-slate-900">

    <!-- Modal de Verificaci√≥n Obligatoria de Fingerprint -->
    <div id="fingerprintVerifyModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[200] items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl border-4 border-amber-400">
            <div class="flex items-center gap-3 mb-4">
                <div class="bg-amber-500 w-12 h-12 rounded-full flex items-center justify-center animate-pulse">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-xl font-black text-slate-800">‚ö†Ô∏è VERIFICACI√ìN OBLIGATORIA</h3>
            </div>
            
            <div class="bg-amber-50 border-2 border-amber-300 rounded-xl p-4 mb-4">
                <p class="text-sm text-amber-900 font-bold mb-2">CR√çTICO: Para prevenir ataques Man-in-the-Middle, DEBES verificar este c√≥digo por otro canal (llamada, WhatsApp, etc.)</p>
                <p class="text-xs text-amber-800">Si no coincide = ATAQUE EN CURSO</p>
            </div>

            <div class="mb-4 bg-slate-100 p-4 rounded-lg">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">C√≥digo de Autenticaci√≥n (SAS)</label>
                <div class="fingerprint-box text-2xl text-center text-indigo-600 font-black" id="sasDisplay">----</div>
            </div>

            <div class="space-y-3">
                <button onclick="confirmFingerprint()" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-colors shadow-lg">
                    ‚úì He verificado - C√≥digo coincide
                </button>
                <button onclick="rejectFingerprint()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition-colors">
                    ‚úó C√≥digo NO coincide - Rechazar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificaci√≥n -->
    <div id="customAlert" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[100] items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl text-center border border-slate-200">
            <div id="alertIcon" class="mx-auto mb-4 w-12 h-12 flex items-center justify-center rounded-full bg-red-100 text-red-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 id="alertTitle" class="text-lg font-bold mb-2">Error</h3>
            <p id="alertMsg" class="text-slate-600 mb-6 text-sm"></p>
            <button onclick="closeAlert()" class="w-full px-4 py-2 bg-slate-900 text-white rounded-xl font-semibold">Cerrar</button>
        </div>
    </div>

    <!-- Modal de Aceptaci√≥n (Handshake) -->
    <div id="requestModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl border border-indigo-100">
            <h3 class="text-xl font-black mb-2 text-slate-800 tracking-tight">üîî Solicitud de Conexi√≥n</h3>
            <p id="requestText" class="text-slate-600 mb-6 font-medium">Un par est√° intentando iniciar un intercambio de llaves.</p>
            <div class="flex gap-3">
                <button onclick="respondToRequest(false)" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-xl font-semibold transition-colors">Rechazar</button>
                <button onclick="respondToRequest(true)" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold transition-colors shadow-lg shadow-indigo-200">Aceptar</button>
            </div>
        </div>
    </div>

    <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[680px] relative border border-white/20">
        
        <!-- Pantalla: Inicio -->
        <div id="setupScreen" class="p-8 flex flex-col h-full justify-center">
            <div class="text-center mb-8">
                <div class="bg-green-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-green-200">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                </div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">SecureP2P <span class="text-green-600">v2.2</span></h1>
                <p class="text-slate-500 text-sm mt-1">ECDH + AES-GCM + HMAC + Anti-Replay</p>
                <div class="mt-2 inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">
                    üõ°Ô∏è Security Fixed
                </div>
            </div>

            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase font-black text-slate-400 ml-1 tracking-widest">Nombre</label>
                    <input type="text" id="nameInput" maxlength="15" placeholder="Alias..." class="w-full px-5 py-3 rounded-xl border-2 border-slate-100 focus:border-green-500 outline-none transition-all font-medium">
                </div>
                
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="createRoom()" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-green-200 active:scale-95">Anfitri√≥n</button>
                    <button onclick="showJoin()" class="px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold transition-all active:scale-95">Invitado</button>
                </div>

                <div class="mt-6 bg-green-50 border border-green-200 rounded-xl p-4">
                    <p class="text-xs text-green-800 font-bold mb-2">üõ°Ô∏è Mejoras de Seguridad v2.2:</p>
                    <ul class="text-xs text-green-700 space-y-1 ml-4 list-disc">
                        <li>Autenticaci√≥n HMAC-SHA256</li>
                        <li>Protecci√≥n Anti-Replay</li>
                        <li>Validaci√≥n de archivos (tipo + tama√±o)</li>
                        <li>Verificaci√≥n obligatoria de identidad</li>
                        <li>Rate limiting implementado</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Pantalla: Unirse -->
        <div id="joinScreen" class="hidden p-8 flex flex-col h-full justify-center">
            <button onclick="backToSetup()" class="text-slate-400 hover:text-slate-600 mb-6 flex items-center gap-2 text-sm font-bold transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Volver
            </button>
            <h2 class="text-xl font-black mb-4">Conectar a Sala</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase font-black text-slate-400 ml-1">ID de Se√±alizaci√≥n</label>
                    <input type="text" id="joinIdInput" placeholder="XXXXXX-XXXXXX" class="w-full px-5 py-3 rounded-xl border-2 border-slate-100 focus:border-green-500 outline-none uppercase text-sm font-mono font-bold tracking-widest">
                </div>
                <button onclick="connectToPeer()" class="w-full px-4 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition-all shadow-lg shadow-green-100 active:scale-95">Iniciar Handshake</button>
            </div>
        </div>

        <!-- Pantalla: Chat -->
        <div id="chatScreen" class="hidden flex flex-col h-full">
            <div class="bg-green-600 p-4 text-white flex justify-between items-center shadow-lg relative z-10">
                <div class="flex items-center gap-3">
                    <button onclick="location.reload()" class="p-1 hover:bg-white/10 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <div>
                        <h2 class="font-bold leading-none text-sm" id="displayPeerName">Conectando...</h2>
                        <span class="text-[10px] opacity-70 font-mono tracking-tighter" id="displayRoomId">ID: ----</span>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-2 text-[9px] bg-black/20 px-2.5 py-1 rounded-full backdrop-blur-md">
                        <div id="statusIndicator" class="w-1.5 h-1.5 rounded-full bg-yellow-400"></div>
                        <span id="statusText" class="font-black uppercase tracking-tighter">Handshake</span>
                    </div>
                    <div id="fingerprint" class="text-[9px] font-mono font-bold text-white/80 hidden bg-black/10 px-2 py-0.5 rounded">SAS: ----</div>
                </div>
            </div>

            <div id="messageContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                <!-- Mensajes -->
            </div>

            <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">

            <div class="p-4 bg-white border-t border-slate-100">
                <div id="shareSection" class="mb-4 p-3 bg-green-50 rounded-xl border border-green-200 hidden">
                    <p class="text-[10px] text-green-600 font-black uppercase mb-1 flex items-center gap-1 text-center">
                        ID DE SE√ëALIZACI√ìN
                    </p>
                    <div class="flex items-center gap-2">
                        <code class="text-xs font-mono font-black text-green-800 break-all select-all bg-white px-2 py-1 rounded border border-green-200" id="shareId">----</code>
                        <button onclick="copyId()" class="p-2 hover:bg-green-200 rounded-lg transition-colors text-green-600 ml-auto">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="flex gap-2 items-center">
                    <button onclick="$('fileInput').click()" id="fileBtn" disabled class="p-2.5 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-full transition-all disabled:opacity-30" title="Enviar archivo (Max 50MB)">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a4 4 0 00-5.656-5.656l-6.415 6.414a6 6 0 108.486 8.486L20.5 13"></path></svg>
                    </button>
                    <input type="text" id="chatInput" maxlength="1000" placeholder="Mensaje cifrado..." class="flex-1 bg-slate-100 px-4 py-2.5 rounded-full outline-none focus:ring-2 ring-green-500 text-sm transition-all border border-transparent">
                    <button onclick="handleSendMessage()" id="sendBtn" disabled class="p-2.5 bg-green-600 text-white rounded-full hover:scale-105 disabled:opacity-30 transition-all shadow-lg shadow-green-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
                
                <div class="flex items-center justify-between mt-3 px-1">
                    <p class="text-[8px] text-slate-400 font-bold flex items-center gap-1 uppercase">
                        <svg class="w-2.5 h-2.5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                        ECDH ‚Ä¢ AES-256 ‚Ä¢ HMAC
                    </p>
                    <p class="text-[8px] text-slate-400">Max 50MB por archivo</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // ====================================================================
        // VARIABLES GLOBALES
        // ====================================================================
        let myPeer, connection, myName;
        let myKeyPairs, sharedSecretKey, hmacKey;
        let pendingConn = null;
        
        // Contadores anti-replay
        let sendCounter = 0;
        let receiveCounter = 0;
        const COUNTER_WINDOW = 100;
        
        // Rate limiting
        let messageTimestamps = [];
        const MAX_MESSAGES_PER_MINUTE = 60;
        let fileTransferTimestamps = [];
        const MAX_FILES_PER_MINUTE = 10;
        
        // Fingerprint verificado
        let fingerprintVerified = false;
        
        // Blob URLs para limpiar
        const blobUrls = new Set();

        const $ = id => document.getElementById(id);

        // ====================================================================
        // VALIDACIONES Y SEGURIDAD
        // ====================================================================
        
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
        const ALLOWED_FILE_TYPES = [
            'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
            'application/pdf',
            'text/plain', 'text/csv',
            'application/zip',
            'video/mp4', 'video/webm',
            'audio/mpeg', 'audio/wav'
        ];

        function sanitizeFileName(filename) {
            // Eliminar caracteres peligrosos
            return filename
                .replace(/[^a-zA-Z0-9._-]/g, '_')
                .substring(0, 255);
        }

        function validateFileSize(size) {
            if (size > MAX_FILE_SIZE) {
                throw new Error(`Archivo demasiado grande. M√°ximo: ${(MAX_FILE_SIZE / 1024 / 1024).toFixed(0)}MB`);
            }
        }

        function validateFileType(type) {
            if (!ALLOWED_FILE_TYPES.includes(type)) {
                throw new Error(`Tipo de archivo no permitido: ${type}`);
            }
        }

        function checkRateLimit(timestamps, maxPerMinute, action) {
            const now = Date.now();
            // Limpiar timestamps antiguos (> 1 minuto)
            const recent = timestamps.filter(t => now - t < 60000);
            timestamps.length = 0;
            timestamps.push(...recent);
            
            if (recent.length >= maxPerMinute) {
                throw new Error(`Rate limit excedido para ${action}. Espera un momento.`);
            }
            
            timestamps.push(now);
        }

        function validateCounter(receivedCounter) {
            // Anti-replay: rechazar mensajes con contadores viejos
            if (receivedCounter <= receiveCounter && 
                receiveCounter - receivedCounter > COUNTER_WINDOW) {
                console.warn("‚ö†Ô∏è Posible replay attack detectado");
                return false;
            }
            
            if (receivedCounter > receiveCounter) {
                receiveCounter = receivedCounter;
            }
            
            return true;
        }

        function validateTimestamp(ts) {
            const now = Date.now();
            const diff = Math.abs(now - ts);
            
            // Rechazar timestamps > 5 minutos en el pasado o futuro
            if (diff > 5 * 60 * 1000) {
                console.warn("‚ö†Ô∏è Timestamp sospechoso:", new Date(ts));
                return false;
            }
            
            return true;
        }

        // ====================================================================
        // N√öCLEO CRIPTOGR√ÅFICO
        // ====================================================================

        async function generateKeyPair() {
            return window.crypto.subtle.generateKey(
                { name: "ECDH", namedCurve: "P-256" },
                false,  // ‚úÖ NO exportable
                ["deriveKey", "deriveBits"]
            );
        }

        async function exportPublicKey(key) {
            const exported = await window.crypto.subtle.exportKey("spki", key);
            return btoa(String.fromCharCode(...new Uint8Array(exported)));
        }

        async function importPublicKey(b64) {
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return window.crypto.subtle.importKey(
                "spki", 
                bytes, 
                { name: "ECDH", namedCurve: "P-256" }, 
                true, 
                []
            );
        }

        async function deriveSharedSecret(privateKey, publicKey) {
            // Derivar bits del secreto compartido
            const sharedBits = await window.crypto.subtle.deriveBits(
                { name: "ECDH", public: publicKey },
                privateKey,
                256
            );
            
            return sharedBits;
        }

        async function deriveSessionKeys(sharedBits) {
            // Importar como material de clave
            const sharedKey = await window.crypto.subtle.importKey(
                "raw",
                sharedBits,
                { name: "HKDF" },
                false,
                ["deriveKey", "deriveBits"]
            );

            // Salt aleatorio √∫nico
            const salt = window.crypto.getRandomValues(new Uint8Array(32));
            
            // Derivar clave AES para cifrado
            const aesKey = await window.crypto.subtle.deriveKey(
                {
                    name: "HKDF",
                    hash: "SHA-256",
                    salt: salt,
                    info: new TextEncoder().encode("encryption-key")
                },
                sharedKey,
                { name: "AES-GCM", length: 256 },
                false,  // ‚úÖ NO exportable
                ["encrypt", "decrypt"]
            );

            // Derivar clave HMAC para autenticaci√≥n
            const macKey = await window.crypto.subtle.deriveKey(
                {
                    name: "HKDF",
                    hash: "SHA-256",
                    salt: salt,
                    info: new TextEncoder().encode("mac-key")
                },
                sharedKey,
                { 
                    name: "HMAC",
                    hash: "SHA-256",
                    length: 256
                },
                false,  // ‚úÖ NO exportable
                ["sign", "verify"]
            );

            console.log("‚úÖ Claves de sesi√≥n derivadas (AES + HMAC)");
            return { aesKey, macKey, salt };
        }

        async function generateHMAC(data, key) {
            const encoder = new TextEncoder();
            const dataString = JSON.stringify(data);
            
            const signature = await window.crypto.subtle.sign(
                "HMAC",
                key,
                encoder.encode(dataString)
            );
            
            return Array.from(new Uint8Array(signature));
        }

        async function verifyHMAC(data, signature, key) {
            const encoder = new TextEncoder();
            const dataString = JSON.stringify(data);
            
            const isValid = await window.crypto.subtle.verify(
                "HMAC",
                key,
                new Uint8Array(signature),
                encoder.encode(dataString)
            );
            
            return isValid;
        }

        async function generateFingerprint(aesKey) {
            const exported = await window.crypto.subtle.exportKey("raw", aesKey);
            const hashBuffer = await crypto.subtle.digest("SHA-256", exported);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const sas = hashArray.slice(0, 4)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('')
                .toUpperCase();
            
            $('fingerprint').textContent = `SAS: ${sas}`;
            $('fingerprint').classList.remove('hidden');
            
            return sas;
        }

        async function encryptData(data, key, counter) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            
            // AAD con contador
            const aad = new Uint8Array(8);
            new DataView(aad.buffer).setBigUint64(0, BigInt(counter), false);
            
            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv, additionalData: aad },
                key,
                data
            );
            
            return {
                data: Array.from(new Uint8Array(encrypted)),
                iv: Array.from(iv)
            };
        }

        async function decryptData(package, key, counter) {
            try {
                // AAD con contador
                const aad = new Uint8Array(8);
                new DataView(aad.buffer).setBigUint64(0, BigInt(counter), false);
                
                const decrypted = await window.crypto.subtle.decrypt(
                    { 
                        name: "AES-GCM", 
                        iv: new Uint8Array(package.iv),
                        additionalData: aad
                    },
                    key,
                    new Uint8Array(package.data)
                );
                return decrypted;
            } catch (e) {
                console.error("‚ùå Fallo de descifrado", e);
                return null;
            }
        }

        // ====================================================================
        // L√ìGICA DE ARCHIVOS
        // ====================================================================

        async function handleFileSelect(input) {
            const file = input.files[0];
            if (!file || !sharedSecretKey || !fingerprintVerified) {
                if (!fingerprintVerified) {
                    showAlert("Verificaci√≥n pendiente", "Primero debes verificar el c√≥digo SAS");
                }
                return;
            }
            
            try {
                // Validaciones
                checkRateLimit(fileTransferTimestamps, MAX_FILES_PER_MINUTE, "transferencia de archivos");
                validateFileSize(file.size);
                validateFileType(file.type);
                
                const safeName = sanitizeFileName(file.name);
                
                systemLog(`Cifrando: ${safeName}...`, "text-indigo-500");
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const now = Date.now();
                        
                        sendCounter++;
                        
                        // Cifrar archivo
                        const encryptedFile = await encryptData(arrayBuffer, sharedSecretKey, sendCounter);
                        
                        // Metadata
                        const meta = { 
                            name: safeName,
                            type: file.type,
                            ts: now,
                            size: file.size
                        };
                        const metaBytes = new TextEncoder().encode(JSON.stringify(meta));
                        const encryptedMeta = await encryptData(metaBytes, sharedSecretKey, sendCounter);

                        // Crear paquete con HMAC
                        const package = {
                            type: 'file',
                            counter: sendCounter,
                            meta: encryptedMeta,
                            payload: encryptedFile
                        };
                        
                        const hmacSig = await generateHMAC(package, hmacKey);
                        package.hmac = hmacSig;

                        connection.send(package);

                        const timeStr = new Date(now).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        addFileMessage(safeName, file.size, 'sent', '', null, timeStr);
                        input.value = '';
                    } catch (err) {
                        showAlert("Error", err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (err) {
                showAlert("Validaci√≥n fallida", err.message);
                input.value = '';
            }
        }

        function addFileMessage(name, size, type, sender = '', blobUrl = null, time = '') {
            const div = document.createElement('div');
            div.className = `flex ${type === 'sent' ? 'justify-end' : 'justify-start'} message-in`;
            
            const inner = document.createElement('div');
            inner.className = `max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${
                type === 'sent' ? 'bg-green-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'
            }`;
            
            if (sender && type === 'received') {
                const s = document.createElement('div');
                s.className = 'text-[9px] font-black opacity-40 mb-1 uppercase';
                s.textContent = sender;
                inner.appendChild(s);
            }

            const formattedSize = (size / 1024 / 1024).toFixed(2) + ' MB';
            
            inner.innerHTML += `
                <div class="flex items-center gap-3">
                    <div class="bg-black/10 p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="font-bold truncate text-xs">${name}</div>
                        <div class="text-[10px] opacity-70">${formattedSize}</div>
                    </div>
                    ${blobUrl ? `
                        <a href="${blobUrl}" download="${name}" class="bg-green-500 hover:bg-green-600 p-2 rounded-full text-white transition-all shadow-md">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </a>
                    ` : `
                        <div class="p-2 opacity-50 italic text-[10px] uppercase font-black">Enviado</div>
                    `}
                </div>
            `;

            if (time) {
                const timeNode = document.createElement('div');
                timeNode.className = `text-[9px] opacity-60 mt-2 ${type === 'sent' ? 'text-right' : 'text-left'}`;
                timeNode.textContent = time;
                inner.appendChild(timeNode);
            }
            
            div.appendChild(inner);
            $('messageContainer').appendChild(div);
            $('messageContainer').scrollTop = $('messageContainer').scrollHeight;
        }

        // ====================================================================
        // L√ìGICA DE CHAT Y UI
        // ====================================================================

        const switchScreen = (id) => {
            ['setupScreen', 'joinScreen', 'chatScreen'].forEach(s => $(s).classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        const addMessage = (text, type, sender = '', time = '') => {
            const div = document.createElement('div');
            div.className = `flex ${type === 'sent' ? 'justify-end' : 'justify-start'} message-in`;
            const inner = document.createElement('div');
            inner.className = `max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${
                type === 'sent' ? 'bg-green-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'
            }`;
            
            if (sender && type === 'received') {
                const s = document.createElement('div');
                s.className = 'text-[9px] font-black opacity-40 mb-1 uppercase';
                s.textContent = sender;
                inner.appendChild(s);
            }
            
            const textNode = document.createElement('div');
            textNode.className = "break-words whitespace-pre-wrap font-medium";
            textNode.textContent = text;
            inner.appendChild(textNode);

            if (time) {
                const timeNode = document.createElement('div');
                timeNode.className = `text-[9px] opacity-60 mt-1 ${type === 'sent' ? 'text-right' : 'text-left'}`;
                timeNode.textContent = time;
                inner.appendChild(timeNode);
            }

            div.appendChild(inner);
            $('messageContainer').appendChild(div);
            $('messageContainer').scrollTop = $('messageContainer').scrollHeight;
        };

        const systemLog = (msg, color = 'text-slate-400') => {
            const div = document.createElement('div');
            div.className = `text-[9px] text-center ${color} my-4 uppercase tracking-[0.2em] font-black px-4`;
            div.textContent = msg;
            $('messageContainer').appendChild(div);
        };

        // ====================================================================
        // VERIFICACI√ìN DE FINGERPRINT OBLIGATORIA
        // ====================================================================

        let pendingSasCode = '';

        function showFingerprintVerification(sas) {
            pendingSasCode = sas;
            $('sasDisplay').textContent = sas;
            $('fingerprintVerifyModal').classList.remove('hidden');
            $('fingerprintVerifyModal').classList.add('flex');
        }

        window.confirmFingerprint = () => {
            fingerprintVerified = true;
            $('fingerprintVerifyModal').classList.add('hidden');
            $('fingerprintVerifyModal').classList.remove('flex');
            activateChatUI(connection.metadata.name || 'Contacto');
            systemLog("‚úÖ Identidad verificada - Chat seguro activado", "text-green-500");
        };

        window.rejectFingerprint = () => {
            $('fingerprintVerifyModal').classList.add('hidden');
            $('fingerprintVerifyModal').classList.remove('flex');
            showAlert("‚ö†Ô∏è Ataque detectado", "El c√≥digo NO coincide. Posible Man-in-the-Middle. Desconectando...");
            setTimeout(() => {
                if (connection) connection.close();
                location.reload();
            }, 3000);
        };

        // ====================================================================
        // CONFIGURACI√ìN DE CONEXI√ìN
        // ====================================================================

        const setupConnection = (conn) => {
            connection = conn;
            
            conn.on('data', async (data) => {
                try {
                    // Handshake inicial
                    if (data.type === 'handshake') {
                        const remotePubKey = await importPublicKey(data.pubKey);
                        
                        if (!myKeyPairs) {
                            myKeyPairs = await generateKeyPair();
                            const myPub = await exportPublicKey(myKeyPairs.publicKey);
                            conn.send({ type: 'handshake_ack', pubKey: myPub, name: myName });
                        }
                        
                        const sharedBits = await deriveSharedSecret(myKeyPairs.privateKey, remotePubKey);
                        const keys = await deriveSessionKeys(sharedBits);
                        sharedSecretKey = keys.aesKey;
                        hmacKey = keys.macKey;
                        
                        const sas = await generateFingerprint(sharedSecretKey);
                        showFingerprintVerification(sas);
                    }

                    if (data.type === 'handshake_ack') {
                        const remotePubKey = await importPublicKey(data.pubKey);
                        const sharedBits = await deriveSharedSecret(myKeyPairs.privateKey, remotePubKey);
                        const keys = await deriveSessionKeys(sharedBits);
                        sharedSecretKey = keys.aesKey;
                        hmacKey = keys.macKey;
                        
                        const sas = await generateFingerprint(sharedSecretKey);
                        showFingerprintVerification(sas);
                    }
                    
                    // Mensajes de chat
                    if (data.type === 'chat') {
                        // Validar contador
                        if (!validateCounter(data.counter)) {
                            systemLog("‚ö†Ô∏è Mensaje rechazado (replay)", "text-red-500");
                            return;
                        }
                        
                        // Verificar HMAC
                        const messageData = {
                            type: data.type,
                            counter: data.counter,
                            payload: data.payload
                        };
                        
                        const isValid = await verifyHMAC(messageData, data.hmac, hmacKey);
                        if (!isValid) {
                            systemLog("‚ö†Ô∏è HMAC inv√°lido - Mensaje rechazado", "text-red-500");
                            addMessage("[Mensaje corrupto o manipulado]", 'received', conn.metadata.name);
                            return;
                        }
                        
                        // Descifrar
                        const decrypted = await decryptData(data.payload, sharedSecretKey, data.counter);
                        if (!decrypted) {
                            addMessage("[Error de descifrado]", 'received', conn.metadata.name);
                            return;
                        }
                        
                        const decoded = JSON.parse(new TextDecoder().decode(decrypted));
                        
                        // Validar timestamp
                        if (!validateTimestamp(decoded.ts)) {
                            systemLog("‚ö†Ô∏è Timestamp sospechoso", "text-amber-500");
                        }
                        
                        const timeStr = new Date(decoded.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        addMessage(decoded.text, 'received', conn.metadata.name, timeStr);
                    }

                    // Archivos
                    if (data.type === 'file') {
                        // Validar contador
                        if (!validateCounter(data.counter)) {
                            systemLog("‚ö†Ô∏è Archivo rechazado (replay)", "text-red-500");
                            return;
                        }
                        
                        // Verificar HMAC
                        const fileData = {
                            type: data.type,
                            counter: data.counter,
                            meta: data.meta,
                            payload: data.payload
                        };
                        
                        const isValid = await verifyHMAC(fileData, data.hmac, hmacKey);
                        if (!isValid) {
                            systemLog("‚ö†Ô∏è Archivo rechazado (HMAC inv√°lido)", "text-red-500");
                            return;
                        }
                        
                        systemLog("Recibiendo archivo cifrado...", "text-green-500");
                        
                        const decryptedMeta = await decryptData(data.meta, sharedSecretKey, data.counter);
                        if (!decryptedMeta) return;
                        
                        const meta = JSON.parse(new TextDecoder().decode(decryptedMeta));
                        
                        // Validar timestamp
                        if (!validateTimestamp(meta.ts)) {
                            systemLog("‚ö†Ô∏è Archivo con timestamp sospechoso", "text-amber-500");
                        }
                        
                        // Validar archivo recibido
                        try {
                            validateFileSize(meta.size);
                            validateFileType(meta.type);
                        } catch (err) {
                            systemLog(`‚ö†Ô∏è Archivo rechazado: ${err.message}`, "text-red-500");
                            return;
                        }
                        
                        const decryptedFile = await decryptData(data.payload, sharedSecretKey, data.counter);
                        if (!decryptedFile) return;
                        
                        const blob = new Blob([decryptedFile], { type: meta.type });
                        const blobUrl = URL.createObjectURL(blob);
                        blobUrls.add(blobUrl);
                        
                        const timeStr = new Date(meta.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        addFileMessage(meta.name, meta.size, 'received', conn.metadata.name, blobUrl, timeStr);
                    }
                } catch (err) {
                    console.error("Error procesando mensaje:", err);
                    systemLog("‚ö†Ô∏è Error procesando mensaje", "text-red-500");
                }
            });

            conn.on('close', () => {
                systemLog("Conexi√≥n cerrada", "text-red-500");
                $('sendBtn').disabled = true;
                $('fileBtn').disabled = true;
                $('statusIndicator').className = 'w-1.5 h-1.5 rounded-full bg-red-400';
                $('statusText').textContent = 'Desconectado';
                
                // Limpiar Blob URLs
                blobUrls.forEach(url => URL.revokeObjectURL(url));
                blobUrls.clear();
            });
        };

        function activateChatUI(peerName) {
            $('statusIndicator').className = 'w-1.5 h-1.5 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]';
            $('statusText').textContent = 'Verificado';
            $('sendBtn').disabled = false;
            $('fileBtn').disabled = false;
            $('displayPeerName').textContent = peerName;
        }

        // ====================================================================
        // ACCIONES DE USUARIO
        // ====================================================================

        window.createRoom = () => {
            const name = $('nameInput').value.trim();
            if (!name) return showAlert("Dato requerido", "Ingresa un alias.");
            myName = name;
            switchScreen('chatScreen');
            initPeer(generateID());
        };

        window.showJoin = () => {
            if (!$('nameInput').value.trim()) return showAlert("Dato requerido", "Ingresa un alias.");
            switchScreen('joinScreen');
        };

        const initPeer = (id) => {
            myPeer = new Peer(id, { debug: 1 });
            myPeer.on('open', (openedId) => {
                $('displayRoomId').textContent = `SALA: ${openedId}`;
                $('shareId').textContent = openedId;
                if (id) $('shareSection').classList.remove('hidden');
                systemLog("Canal de se√±alizaci√≥n abierto", "text-indigo-500");
            });
            
            myPeer.on('connection', async (conn) => {
                pendingConn = conn;
                $('requestText').textContent = `"${conn.metadata.name}" solicita conexi√≥n.`;
                $('requestModal').classList.remove('hidden');
                $('requestModal').classList.add('flex');
            });
        };

        window.connectToPeer = async () => {
            const targetId = $('joinIdInput').value.trim().toUpperCase();
            myName = $('nameInput').value.trim();
            initPeer(null); 
            
            setTimeout(() => {
                const conn = myPeer.connect(targetId, { 
                    metadata: { name: myName },
                    reliable: true 
                });
                setupConnection(conn);
                switchScreen('chatScreen');
                systemLog("Iniciando handshake...", "text-indigo-500");
            }, 800);
        };

        window.respondToRequest = async (accept) => {
            $('requestModal').classList.add('hidden');
            $('requestModal').classList.remove('flex');
            
            if (accept && pendingConn) {
                myKeyPairs = await generateKeyPair();
                const myPublicB64 = await exportPublicKey(myKeyPairs.publicKey);
                setupConnection(pendingConn);
                pendingConn.send({ type: 'handshake', pubKey: myPublicB64, name: myName });
                systemLog("Intercambiando claves ECDH...", "text-indigo-500");
            } else if (pendingConn) {
                pendingConn.close();
            }
        };

        window.handleSendMessage = async () => {
            const text = $('chatInput').value.trim();
            if (!text || !connection || !sharedSecretKey || !fingerprintVerified) {
                if (!fingerprintVerified) {
                    showAlert("Verificaci√≥n pendiente", "Debes verificar el c√≥digo SAS primero");
                }
                return;
            }
            
            try {
                checkRateLimit(messageTimestamps, MAX_MESSAGES_PER_MINUTE, "mensajes");
                
                const now = Date.now();
                sendCounter++;
                
                const payload = new TextEncoder().encode(JSON.stringify({ 
                    text: text, 
                    ts: now 
                }));
                
                const encrypted = await encryptData(payload, sharedSecretKey, sendCounter);
                
                const package = {
                    type: 'chat',
                    counter: sendCounter,
                    payload: encrypted
                };
                
                const hmacSig = await generateHMAC(package, hmacKey);
                package.hmac = hmacSig;
                
                connection.send(package);
                
                const timeStr = new Date(now).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                addMessage(text, 'sent', '', timeStr);
                $('chatInput').value = '';
            } catch (err) {
                showAlert("Error", err.message);
            }
        };

        const showAlert = (title, msg) => {
            $('alertTitle').textContent = title;
            $('alertMsg').textContent = msg;
            $('customAlert').classList.remove('hidden');
            $('customAlert').classList.add('flex');
        };
        
        window.closeAlert = () => {
            $('customAlert').classList.add('hidden');
            $('customAlert').classList.remove('flex');
        };
        
        window.copyId = () => { 
            navigator.clipboard.writeText($('shareId').textContent); 
            systemLog("ID Copiado", "text-green-500"); 
        };
        
        window.backToSetup = () => switchScreen('setupScreen');
        
        const generateID = () => {
            return Math.random().toString(36).substring(2, 8).toUpperCase() + '-' + 
                   Math.random().toString(36).substring(2, 8).toUpperCase();
        };
        
        $('chatInput').onkeypress = (e) => { 
            if(e.key === 'Enter') handleSendMessage(); 
        };

        // Limpiar al cerrar ventana
        window.addEventListener('beforeunload', () => {
            blobUrls.forEach(url => URL.revokeObjectURL(url));
        });
    </script>
</body>
</html>
