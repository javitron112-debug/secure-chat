<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureP2P v2.1 - File Transfer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-in { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex items-center justify-center p-4 font-sans text-slate-900">

    <!-- Modal de Notificaci√≥n -->
    <div id="customAlert" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[100] items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl text-center border border-slate-200">
            <div id="alertIcon" class="mx-auto mb-4 w-12 h-12 flex items-center justify-center rounded-full bg-red-100 text-red-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 id="alertTitle" class="text-lg font-bold mb-2">Error</h3>
            <p id="alertMsg" class="text-slate-600 mb-6 text-sm"></p>
            <button onclick="closeAlert()" class="w-full px-4 py-2 bg-slate-900 text-white rounded-xl font-semibold">Cerrar</button>
        </div>
    </div>

    <!-- Modal de Aceptaci√≥n (Handshake) -->
    <div id="requestModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl border border-indigo-100">
            <h3 class="text-xl font-black mb-2 text-slate-800 tracking-tight">üîî Solicitud de Conexi√≥n</h3>
            <p id="requestText" class="text-slate-600 mb-6 font-medium">Un par est√° intentando iniciar un intercambio de llaves.</p>
            <div class="flex gap-3">
                <button onclick="respondToRequest(false)" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-xl font-semibold transition-colors">Rechazar</button>
                <button onclick="respondToRequest(true)" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold transition-colors shadow-lg shadow-indigo-200">Aceptar e Intercambiar</button>
            </div>
        </div>
    </div>

    <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[680px] relative border border-white/20">
        
        <!-- Pantalla: Inicio -->
        <div id="setupScreen" class="p-8 flex flex-col h-full justify-center">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-indigo-200">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight italic">SecureP2P <span class="text-indigo-600">v2.1</span></h1>
                <p class="text-slate-500 text-sm mt-1">ECDH + AES-GCM + File Transfer</p>
            </div>

            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase font-black text-slate-400 ml-1 tracking-widest">Nombre de Pantalla</label>
                    <input type="text" id="nameInput" maxlength="15" placeholder="Alias..." class="w-full px-5 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none transition-all font-medium">
                </div>
                
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="createRoom()" class="px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-indigo-200 active:scale-95">Anfitri√≥n</button>
                    <button onclick="showJoin()" class="px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold transition-all active:scale-95">Invitado</button>
                </div>
            </div>
        </div>

        <!-- Pantalla: Unirse -->
        <div id="joinScreen" class="hidden p-8 flex flex-col h-full justify-center">
            <button onclick="backToSetup()" class="text-slate-400 hover:text-slate-600 mb-6 flex items-center gap-2 text-sm font-bold transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Volver
            </button>
            <h2 class="text-xl font-black mb-4">Conectar a Sala</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase font-black text-slate-400 ml-1">ID de Se√±alizaci√≥n</label>
                    <input type="text" id="joinIdInput" placeholder="XXXXXX-XXXXXX" class="w-full px-5 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none uppercase text-sm font-mono font-bold tracking-widest">
                </div>
                <button onclick="connectToPeer()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 active:scale-95">Solicitar Handshake</button>
            </div>
        </div>

        <!-- Pantalla: Chat -->
        <div id="chatScreen" class="hidden flex flex-col h-full">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-lg relative z-10">
                <div class="flex items-center gap-3">
                    <button onclick="location.reload()" class="p-1 hover:bg-white/10 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <div>
                        <h2 class="font-bold leading-none text-sm" id="displayPeerName">Conectando...</h2>
                        <span class="text-[10px] opacity-70 font-mono tracking-tighter" id="displayRoomId">ID: ----</span>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-2 text-[9px] bg-black/20 px-2.5 py-1 rounded-full backdrop-blur-md">
                        <div id="statusIndicator" class="w-1.5 h-1.5 rounded-full bg-yellow-400"></div>
                        <span id="statusText" class="font-black uppercase tracking-tighter">Handshake</span>
                    </div>
                    <div id="fingerprint" class="text-[9px] font-mono font-bold text-white/60 hidden bg-black/10 px-1.5 rounded">SAS: ----</div>
                </div>
            </div>

            <div id="messageContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                <!-- Mensajes -->
            </div>

            <!-- Area de carga de archivos (hidden input) -->
            <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">

            <div class="p-4 bg-white border-t border-slate-100">
                <div id="shareSection" class="mb-4 p-3 bg-indigo-50 rounded-xl border border-indigo-100 hidden">
                    <p class="text-[10px] text-indigo-600 font-black uppercase mb-1 flex items-center gap-1 text-center">
                        ID DE SE√ëALIZACI√ìN (S√ìLO PARA ENCONTRARSE)
                    </p>
                    <div class="flex items-center gap-2">
                        <code class="text-xs font-mono font-black text-indigo-800 break-all select-all bg-white px-2 py-1 rounded border border-indigo-200" id="shareId">----</code>
                        <button onclick="copyId()" class="p-2 hover:bg-indigo-200 rounded-lg transition-colors text-indigo-600 ml-auto">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="flex gap-2 items-center">
                    <button onclick="$('fileInput').click()" id="fileBtn" disabled class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all disabled:opacity-30">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a4 4 0 00-5.656-5.656l-6.415 6.414a6 6 0 108.486 8.486L20.5 13"></path></svg>
                    </button>
                    <input type="text" id="chatInput" maxlength="1000" placeholder="Escribe un mensaje cifrado..." class="flex-1 bg-slate-100 px-4 py-2.5 rounded-full outline-none focus:ring-2 ring-indigo-500 text-sm transition-all border border-transparent">
                    <button onclick="handleSendMessage()" id="sendBtn" disabled class="p-2.5 bg-indigo-600 text-white rounded-full hover:scale-105 disabled:opacity-30 transition-all shadow-lg shadow-indigo-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
                
                <div class="flex items-center justify-between mt-3 px-1">
                    <p class="text-[8px] text-slate-400 font-bold flex items-center gap-1 uppercase">
                        <svg class="w-2.5 h-2.5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                        AES-256 GCM + ECDH P-256
                    </p>
                    <p class="text-[8px] text-slate-300 italic">Transferencia directa ‚Ä¢ Sin l√≠mites de tama√±o</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        let myPeer, connection, myName, sharedSecretKey, myKeyPairs;
        let pendingConn = null;
        let lastReceivedTimestamp = 0;

        const $ = id => document.getElementById(id);

        const switchScreen = (id) => {
            ['setupScreen', 'joinScreen', 'chatScreen'].forEach(s => $(s).classList.add('hidden'));
            $(id).classList.remove('hidden');
        };
        
        // --- N√∫cleo Criptogr√°fico ---

        async function generateKeyPair() {
            return window.crypto.subtle.generateKey(
                { name: "ECDH", namedCurve: "P-256" },
                false, ["deriveKey"]
            );
        }

        async function exportPublicKey(key) {
            const exported = await window.crypto.subtle.exportKey("spki", key);
            return btoa(String.fromCharCode(...new Uint8Array(exported)));
        }

        async function importPublicKey(b64) {
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return window.crypto.subtle.importKey(
                "spki", bytes, { name: "ECDH", namedCurve: "P-256" }, true, []
            );
        }

        async function deriveSharedSecret(privateKey, publicKey) {
            return window.crypto.subtle.deriveKey(
                { name: "ECDH", public: publicKey },
                privateKey,
                { name: "AES-GCM", length: 256 },
                true, ["encrypt", "decrypt"]
            );
        }

        async function generateFingerprint(aesKey) {
            const exported = await window.crypto.subtle.exportKey("raw", aesKey);
            const hashBuffer = await crypto.subtle.digest("SHA-256", exported);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const sas = hashArray.slice(0, 4).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
            $('fingerprint').textContent = `SAS: ${sas}`;
            $('fingerprint').classList.remove('hidden');
        }

        // Cifrar datos gen√©ricos (String o ArrayBuffer)
        async function encryptData(data, key) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                data
            );
            return {
                data: Array.from(new Uint8Array(encrypted)),
                iv: Array.from(iv)
            };
        }

        // Descifrar datos gen√©ricos
        async function decryptData(package, key) {
            try {
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(package.iv) },
                    key,
                    new Uint8Array(package.data)
                );
                return decrypted;
            } catch (e) {
                console.error("Fallo de descifrado", e);
                return null;
            }
        }

        // --- L√≥gica de Archivos ---

        async function handleFileSelect(input) {
            const file = input.files[0];
            if (!file || !sharedSecretKey) return;
            
            systemLog(`Cifrando archivo: ${file.name}...`, "text-indigo-400");
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                const now = new Date();
                
                // Ciframos el contenido del archivo
                const encryptedFile = await encryptData(arrayBuffer, sharedSecretKey);
                
                // Ciframos los metadatos (nombre, tipo)
                const meta = JSON.stringify({ 
                    name: file.name, 
                    type: file.type, 
                    ts: now.getTime(),
                    size: file.size
                });
                const encryptedMeta = await encryptData(new TextEncoder().encode(meta), sharedSecretKey);

                connection.send({
                    type: 'file',
                    meta: encryptedMeta,
                    payload: encryptedFile
                });

                const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                addFileMessage(file.name, file.size, 'sent', '', null, timeStr);
                input.value = ''; // Reset input
            };
            reader.readAsArrayBuffer(file);
        }

        function addFileMessage(name, size, type, sender = '', blobUrl = null, time = '') {
            const div = document.createElement('div');
            div.className = `flex ${type === 'sent' ? 'justify-end' : 'justify-start'} message-in`;
            
            const inner = document.createElement('div');
            inner.className = `max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${
                type === 'sent' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'
            }`;
            
            if (sender && type === 'received') {
                const s = document.createElement('div');
                s.className = 'text-[9px] font-black opacity-40 mb-1 uppercase';
                s.textContent = sender;
                inner.appendChild(s);
            }

            const formattedSize = (size / 1024 / 1024).toFixed(2) + ' MB';
            
            inner.innerHTML += `
                <div class="flex items-center gap-3">
                    <div class="bg-black/10 p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="font-bold truncate text-xs">${name}</div>
                        <div class="text-[10px] opacity-70">${formattedSize}</div>
                    </div>
                    ${blobUrl ? `
                        <a href="${blobUrl}" download="${name}" class="bg-green-500 hover:bg-green-600 p-2 rounded-full text-white transition-all shadow-md">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </a>
                    ` : `
                        <div class="p-2 opacity-50 italic text-[10px] uppercase font-black tracking-widest">Enviado</div>
                    `}
                </div>
            `;

            if (time) {
                const timeNode = document.createElement('div');
                timeNode.className = `text-[9px] opacity-60 mt-2 ${type === 'sent' ? 'text-right' : 'text-left'}`;
                timeNode.textContent = time;
                inner.appendChild(timeNode);
            }
            
            div.appendChild(inner);
            $('messageContainer').appendChild(div);
            $('messageContainer').scrollTop = $('messageContainer').scrollHeight;
        }

        // --- L√≥gica de Chat y UI ---

        const addMessage = (text, type, sender = '', time = '') => {
            const div = document.createElement('div');
            div.className = `flex ${type === 'sent' ? 'justify-end' : 'justify-start'} message-in`;
            const inner = document.createElement('div');
            inner.className = `max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${
                type === 'sent' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'
            }`;
            if (sender && type === 'received') {
                const s = document.createElement('div');
                s.className = 'text-[9px] font-black opacity-40 mb-1 uppercase';
                s.textContent = sender;
                inner.appendChild(s);
            }
            const textNode = document.createElement('div');
            textNode.className = "break-words whitespace-pre-wrap font-medium";
            textNode.textContent = text;
            inner.appendChild(textNode);

            if (time) {
                const timeNode = document.createElement('div');
                timeNode.className = `text-[9px] opacity-60 mt-1 ${type === 'sent' ? 'text-right' : 'text-left'}`;
                timeNode.textContent = time;
                inner.appendChild(timeNode);
            }

            div.appendChild(inner);
            $('messageContainer').appendChild(div);
            $('messageContainer').scrollTop = $('messageContainer').scrollHeight;
        };

        const systemLog = (msg, color = 'text-slate-400') => {
            const div = document.createElement('div');
            div.className = `text-[9px] text-center ${color} my-4 uppercase tracking-[0.2em] font-black px-4`;
            div.textContent = msg;
            $('messageContainer').appendChild(div);
        };

        const setupConnection = (conn) => {
            connection = conn;
            conn.on('data', async (data) => {
                if (data.type === 'handshake') {
                    const remotePubKey = await importPublicKey(data.pubKey);
                    if (!myKeyPairs) {
                        myKeyPairs = await generateKeyPair();
                        const myPub = await exportPublicKey(myKeyPairs.publicKey);
                        conn.send({ type: 'handshake_ack', pubKey: myPub, name: myName });
                    }
                    sharedSecretKey = await deriveSharedSecret(myKeyPairs.privateKey, remotePubKey);
                    await generateFingerprint(sharedSecretKey);
                    activateChatUI(data.name);
                }

                if (data.type === 'handshake_ack') {
                    const remotePubKey = await importPublicKey(data.pubKey);
                    sharedSecretKey = await deriveSharedSecret(myKeyPairs.privateKey, remotePubKey);
                    await generateFingerprint(sharedSecretKey);
                    activateChatUI(data.name);
                }
                
                if (data.type === 'chat') {
                    const decrypted = await decryptData(data.payload, sharedSecretKey);
                    const decoded = JSON.parse(new TextDecoder().decode(decrypted));
                    const timeStr = new Date(decoded.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    addMessage(decoded.text, 'received', connection.metadata.name, timeStr);
                }

                if (data.type === 'file') {
                    systemLog("Recibiendo archivo cifrado...", "text-green-500");
                    const decryptedMeta = await decryptData(data.meta, sharedSecretKey);
                    const meta = JSON.parse(new TextDecoder().decode(decryptedMeta));
                    
                    const decryptedFile = await decryptData(data.payload, sharedSecretKey);
                    const blob = new Blob([decryptedFile], { type: meta.type });
                    const blobUrl = URL.createObjectURL(blob);
                    
                    const timeStr = new Date(meta.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    addFileMessage(meta.name, meta.size, 'received', connection.metadata.name, blobUrl, timeStr);
                }
            });

            conn.on('close', () => {
                systemLog("Conexi√≥n finalizada", "text-red-500");
                $('sendBtn').disabled = true;
                $('fileBtn').disabled = true;
                $('statusIndicator').className = 'w-1.5 h-1.5 rounded-full bg-red-400';
            });
        };

        function activateChatUI(peerName) {
            $('statusIndicator').className = 'w-1.5 h-1.5 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]';
            $('statusText').textContent = 'Encriptado';
            $('sendBtn').disabled = false;
            $('fileBtn').disabled = false;
            $('displayPeerName').textContent = peerName || "Contacto";
            systemLog("Handshake E2E verificado", "text-indigo-500");
        }

        // --- Acciones de Bot√≥n ---

        window.createRoom = () => {
            const name = $('nameInput').value.trim();
            if (!name) return showAlert("Dato requerido", "Ingresa un alias.");
            myName = name;
            switchScreen('chatScreen');
            initPeer(generateID());
        };

        window.showJoin = () => {
            if (!$('nameInput').value.trim()) return showAlert("Dato requerido", "Ingresa un alias primero.");
            switchScreen('joinScreen');
        };

        const initPeer = (id) => {
            myPeer = new Peer(id, { debug: 1 });
            myPeer.on('open', (openedId) => {
                $('displayRoomId').textContent = `SALA: ${openedId}`;
                $('shareId').textContent = openedId;
                if (id) $('shareSection').classList.remove('hidden');
            });
            myPeer.on('connection', async (conn) => {
                pendingConn = conn;
                $('requestText').textContent = `"${conn.metadata.name}" solicita handshake.`;
                $('requestModal').classList.remove('hidden');
                $('requestModal').classList.add('flex');
            });
        };

        window.connectToPeer = async () => {
            const targetId = $('joinIdInput').value.trim().toUpperCase();
            myName = $('nameInput').value.trim();
            initPeer(null); 
            setTimeout(() => {
                const conn = myPeer.connect(targetId, { metadata: { name: myName }, reliable: true });
                setupConnection(conn);
                switchScreen('chatScreen');
                systemLog("Solicitando handshake...");
            }, 800);
        };

        window.respondToRequest = async (accept) => {
            $('requestModal').classList.add('hidden');
            $('requestModal').classList.remove('flex');
            if (accept && pendingConn) {
                myKeyPairs = await generateKeyPair();
                const myPublicB64 = await exportPublicKey(myKeyPairs.publicKey);
                setupConnection(pendingConn);
                pendingConn.send({ type: 'handshake', pubKey: myPublicB64, name: myName });
            } else if (pendingConn) pendingConn.close();
        };

        window.handleSendMessage = async () => {
            const text = $('chatInput').value.trim();
            if (!text || !connection || !sharedSecretKey) return;
            const now = new Date();
            const payload = new TextEncoder().encode(JSON.stringify({ text: text, ts: now.getTime() }));
            const encrypted = await encryptData(payload, sharedSecretKey);
            connection.send({ type: 'chat', payload: encrypted });
            
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            addMessage(text, 'sent', '', timeStr);
            $('chatInput').value = '';
        };

        const showAlert = (title, msg) => {
            $('alertTitle').textContent = title;
            $('alertMsg').textContent = msg;
            $('customAlert').classList.remove('hidden');
            $('customAlert').classList.add('flex');
        };
        window.closeAlert = () => $('customAlert').classList.add('hidden');
        window.copyId = () => { navigator.clipboard.writeText($('shareId').textContent); systemLog("ID Copiado"); };
        window.backToSetup = () => switchScreen('setupScreen');
        const generateID = () => Math.random().toString(36).substring(2, 8).toUpperCase() + '-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        $('chatInput').onkeypress = (e) => { if(e.key === 'Enter') handleSendMessage(); };
    </script>
</body>
</html>
