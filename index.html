<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P Cifrado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .chat-container {
            max-width: 800px;
            width: 100%;
            height: 90vh;
            max-height: 700px;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .info-box {
            background: #e7f5ff;
            border-left: 4px solid #1971c2;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 14px;
            color: #1971c2;
        }

        .password-display {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .password-display .label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .password-display .password {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
            letter-spacing: 4px;
            margin: 10px 0;
        }

        .password-display .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .password-display .copy-btn:hover {
            background: #5568d3;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #51cf66;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.received .message-content {
            background: white;
            border-bottom-left-radius: 4px;
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-text {
            margin: 4px 0;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .system-message {
            text-align: center;
            color: #6c757d;
            font-size: 13px;
            margin: 15px 0;
            padding: 8px;
            background: rgba(108, 117, 125, 0.1);
            border-radius: 8px;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }

        .input-area input:focus {
            border-color: #667eea;
        }

        .input-area button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .input-area button:hover {
            transform: scale(1.05);
        }

        .waiting-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .waiting-message .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Pantalla 1: Bienvenida y nombre -->
    <div class="container" id="nameScreen">
        <div class="header">
            <h1>üîê Chat Seguro P2P</h1>
            <p>Sin servidores ‚Ä¢ Cifrado de extremo a extremo</p>
        </div>
        <div class="content">
            <div class="info-box">
                üí° Este chat no requiere registro y no almacena ning√∫n dato. Todo est√° cifrado entre t√∫ y tu contacto.
            </div>
            <div class="input-group">
                <label>¬øC√≥mo te llamas?</label>
                <input type="text" id="nameInput" placeholder="Tu nombre" autofocus>
            </div>
            <button class="btn btn-primary" onclick="setName()">Continuar ‚Üí</button>
        </div>
    </div>

    <!-- Pantalla 2: Crear o unirse -->
    <div class="container" id="choiceScreen" style="display: none;">
        <div class="header">
            <h1>üëã Hola, <span id="userName"></span></h1>
            <p>¬øQu√© quieres hacer?</p>
        </div>
        <div class="content">
            <button class="btn btn-primary" onclick="showCreateRoom()">üîë Crear nueva sala</button>
            <button class="btn btn-secondary" onclick="showJoinRoom()">üö™ Unirme a una sala</button>
        </div>
    </div>

    <!-- Pantalla 3: Crear sala -->
    <div class="container" id="createScreen" style="display: none;">
        <div class="header">
            <h1>üîë Crear Sala</h1>
            <p>Se generar√° una contrase√±a √∫nica</p>
        </div>
        <div class="content">
            <div class="password-display">
                <div class="label">Contrase√±a de la sala</div>
                <div class="password" id="roomPassword">----</div>
                <button class="copy-btn" onclick="copyPassword()">üìã Copiar contrase√±a</button>
            </div>
            <div class="info-box">
                ‚úÖ Sala creada. Comparte esta contrase√±a con tu contacto para que pueda unirse.
            </div>
            <button class="btn btn-primary" onclick="startHosting()">Continuar ‚Üí</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Pantalla 4: Unirse a sala -->
    <div class="container" id="joinScreen" style="display: none;">
        <div class="header">
            <h1>üö™ Unirse a Sala</h1>
            <p>Introduce la contrase√±a que te compartieron</p>
        </div>
        <div class="content">
            <div class="input-group">
                <label>Contrase√±a de la sala</label>
                <input type="text" id="joinPassword" placeholder="Ej: ABCD" maxlength="4" style="text-transform: uppercase;">
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">Unirse ‚Üí</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Volver</button>
        </div>
    </div>

    <!-- Pantalla 5: Chat -->
    <div class="container chat-container" id="chatScreen" style="display: none;">
        <div class="header">
            <h1>üí¨ Chat</h1>
            <p>Sala: <span id="chatRoomId"></span></p>
        </div>
        <div class="status-bar">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Esperando conexi√≥n...</span>
            </div>
            <div style="font-size: 12px; color: #6c757d;">
                üîí Cifrado E2E
            </div>
        </div>
        <div class="messages" id="messages">
            <div class="waiting-message" id="waitingMessage">
                <div class="spinner"></div>
                <p><strong>Esperando a que tu contacto se una...</strong></p>
                <p style="font-size: 14px; margin-top: 10px;">Aseg√∫rate de que tenga la contrase√±a correcta</p>
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Escribe un mensaje..." disabled>
            <button onclick="sendMessage()" disabled id="sendButton">Enviar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        let userName = '';
        let roomId = '';
        let peer = null;
        let conn = null;
        let isHost = false;

        // Pantalla 1: Establecer nombre
        function setName() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('Por favor ingresa tu nombre');
                return;
            }
            userName = name;
            document.getElementById('userName').textContent = userName;
            showScreen('choiceScreen');
        }

        // Pantalla 2: Mostrar opciones
        function showCreateRoom() {
            const password = generatePassword();
            roomId = password;
            document.getElementById('roomPassword').textContent = password;
            showScreen('createScreen');
        }

        function showJoinRoom() {
            showScreen('joinScreen');
        }

        // Generar contrase√±a de 4 caracteres
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Copiar contrase√±a
        function copyPassword() {
            const password = document.getElementById('roomPassword').textContent;
            navigator.clipboard.writeText(password).then(() => {
                alert('‚úÖ Contrase√±a copiada: ' + password);
            });
        }

        // Iniciar como host
        function startHosting() {
            isHost = true;
            document.getElementById('chatRoomId').textContent = roomId;
            showScreen('chatScreen');
            initPeer(roomId);
        }

        // Unirse a sala
        function joinRoom() {
            const password = document.getElementById('joinPassword').value.trim().toUpperCase();
            if (!password || password.length !== 4) {
                alert('Por favor ingresa una contrase√±a v√°lida de 4 caracteres');
                return;
            }
            isHost = false;
            roomId = password;
            document.getElementById('chatRoomId').textContent = roomId;
            showScreen('chatScreen');
            initPeer(null, password);
        }

        // Inicializar PeerJS
        function initPeer(id, connectTo) {
            // Usar servidor p√∫blico de PeerJS
            peer = new Peer(id, {
                host: '0.peerjs.com',
                secure: true,
                port: 443,
                debug: 2
            });

            peer.on('open', (peerId) => {
                console.log('Mi Peer ID:', peerId);
                addSystemMessage('‚úÖ Conectado al servidor');
                
                if (connectTo) {
                    // Cliente: conectar al host
                    setTimeout(() => {
                        connectToPeer(connectTo);
                    }, 1000);
                } else {
                    // Host: esperar conexi√≥n
                    addSystemMessage('‚è≥ Esperando a que alguien se una...');
                }
            });

            peer.on('connection', (connection) => {
                console.log('‚úÖ Alguien se est√° conectando...');
                setupConnection(connection);
            });

            peer.on('error', (err) => {
                console.error('‚ùå Error de Peer:', err);
                if (err.type === 'peer-unavailable') {
                    addSystemMessage('‚ùå No se pudo encontrar la sala. Verifica la contrase√±a.');
                } else if (err.type === 'unavailable-id') {
                    addSystemMessage('‚ùå Esta sala ya existe. Prueba con otra contrase√±a.');
                } else {
                    addSystemMessage('‚ùå Error: ' + err.type);
                }
            });

            peer.on('disconnected', () => {
                console.log('‚ö†Ô∏è Desconectado del servidor');
                addSystemMessage('‚ö†Ô∏è Desconectado del servidor. Intentando reconectar...');
                peer.reconnect();
            });
        }

        // Conectar a otro peer
        function connectToPeer(peerId) {
            console.log('Conectando a:', peerId);
            addSystemMessage('‚è≥ Conectando a la sala...');
            conn = peer.connect(peerId, {
                reliable: true,
                serialization: 'json'
            });
            setupConnection(conn);
        }

        // Configurar conexi√≥n
        function setupConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                console.log('‚úÖ Conexi√≥n P2P establecida');
                document.getElementById('waitingMessage').style.display = 'none';
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Conectado';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
                addSystemMessage('üéâ ¬°Conectado! Ya puedes chatear de forma segura.');
                
                // Enviar mensaje de bienvenida
                conn.send({
                    type: 'join',
                    name: userName,
                    time: new Date().toLocaleTimeString()
                });
            });

            conn.on('data', (data) => {
                console.log('üì® Mensaje recibido:', data);
                if (data.type === 'join') {
                    addSystemMessage('üë§ ' + data.name + ' se ha unido al chat');
                } else if (data.type === 'message') {
                    addMessage(data.text, 'received', data.name, data.time);
                }
            });

            conn.on('close', () => {
                console.log('‚ùå Conexi√≥n cerrada');
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Desconectado';
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
                addSystemMessage('‚ùå Tu contacto se ha desconectado');
            });

            conn.on('error', (err) => {
                console.error('‚ùå Error en conexi√≥n:', err);
                addSystemMessage('‚ùå Error en la conexi√≥n: ' + err);
            });
        }

        // Enviar mensaje
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !conn) return;

            const message = {
                type: 'message',
                text: text,
                name: userName,
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
            };

            conn.send(message);
            addMessage(text, 'sent', userName, message.time);
            input.value = '';
        }

        // Enter para enviar
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('nameInput');
            if (nameInput) {
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') setName();
                });
            }
            
            const joinPasswordInput = document.getElementById('joinPassword');
            if (joinPasswordInput) {
                joinPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') joinRoom();
                });
            }
            
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
            }
        });

        // A√±adir mensaje a la interfaz
        function addMessage(text, type, sender, time) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let senderHtml = '';
            if (type === 'received') {
                senderHtml = `<div class="message-sender">${escapeHtml(sender)}</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${senderHtml}
                    <div class="message-text">${escapeHtml(text)}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // A√±adir mensaje del sistema
        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cambiar pantalla
        function showScreen(screenId) {
            document.querySelectorAll('.container').forEach(container => {
                container.style.display = 'none';
            });
            document.getElementById(screenId).style.display = 'block';
        }

        // Volver
        function goBack() {
            if (peer) {
                peer.destroy();
                peer = null;
            }
            if (conn) {
                conn.close();
                conn = null;
            }
            showScreen('choiceScreen');
        }
    </script>
</body>
</html>
