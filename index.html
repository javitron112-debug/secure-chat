<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureTalk | Comunicaci√≥n Ef√≠mera</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-container video { transform: scaleX(-1); } /* Efecto espejo para uno mismo */
        .remote-video video { transform: scaleX(1); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans overflow-hidden">

    <div id="login" class="flex flex-col items-center justify-center h-screen transition-all">
        <div class="bg-slate-900 p-10 rounded-3xl shadow-2xl border border-slate-800 w-full max-w-md text-center">
            <div class="text-5xl mb-4">üîê</div>
            <h1 class="text-3xl font-black mb-2 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">SecureTalk</h1>
            <p class="text-slate-400 mb-8 text-sm">Introduce un c√≥digo privado para iniciar o unirte.</p>
            
            <input type="text" id="roomCode" placeholder="Ej: mi-reunion-secreta" 
                class="w-full p-4 rounded-xl bg-slate-950 border border-slate-700 mb-4 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all text-center font-mono uppercase tracking-widest">
            
            <button onclick="startApp()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-lg transition-all shadow-lg shadow-blue-900/20">
                Entrar a la Sala
            </button>
        </div>
    </div>

    <div id="room" class="hidden h-screen flex flex-col transition-all">
        <header class="p-4 bg-slate-900/50 backdrop-blur-md border-b border-slate-800 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="flex h-3 w-3 rounded-full bg-emerald-500 animate-pulse"></span>
                <h2 class="font-mono font-bold">SALA: <span id="displayCode" class="text-blue-400"></span></h2>
            </div>
            <div class="flex gap-2">
                <button onclick="copyInvite()" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold transition">üîó COPIAR INVITACI√ìN</button>
                <button onclick="location.reload()" class="bg-red-900/50 hover:bg-red-600 px-4 py-2 rounded-lg text-xs font-bold transition">SALIR</button>
            </div>
        </header>

        <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <div id="video-grid" class="flex-1 p-4 grid grid-cols-1 sm:grid-cols-2 gap-4 auto-rows-fr overflow-y-auto bg-slate-950">
                <div class="relative rounded-2xl overflow-hidden bg-slate-900 border border-slate-800 video-container">
                    <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
                    <div class="absolute bottom-4 left-4 bg-black/60 backdrop-blur-md px-3 py-1 rounded-full text-xs">T√∫ (Local)</div>
                </div>
            </div>

            <div class="w-full md:w-80 bg-slate-900 border-l border-slate-800 flex flex-col">
                <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-3 text-sm">
                    <p class="text-slate-500 italic text-center text-xs">Los mensajes se cifran con tu c√≥digo y no se guardan en ning√∫n servidor.</p>
                </div>
                <div class="p-4 bg-slate-950">
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" placeholder="Escribe algo..." class="flex-1 bg-slate-900 p-2 rounded-lg outline-none border border-slate-800 focus:border-blue-500 text-sm">
                        <button onclick="sendMessage()" class="bg-blue-600 p-2 rounded-lg">‚û§</button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="p-6 bg-slate-900 border-t border-slate-800 flex justify-center items-center gap-8">
            <button id="btnMic" onclick="toggleMic()" class="group flex flex-col items-center gap-2">
                <div class="p-4 bg-slate-800 group-hover:bg-slate-700 rounded-full transition">üéôÔ∏è</div>
                <span class="text-[10px] uppercase tracking-tighter">Micro</span>
            </button>
            <button id="btnCam" onclick="toggleCam()" class="group flex flex-col items-center gap-2">
                <div class="p-4 bg-slate-800 group-hover:bg-slate-700 rounded-full transition">üì∑</div>
                <span class="text-[10px] uppercase tracking-tighter">C√°mara</span>
            </button>
            <button onclick="shareScreen()" class="group flex flex-col items-center gap-2 text-emerald-400">
                <div class="p-4 bg-emerald-900/20 group-hover:bg-emerald-900/40 rounded-full transition border border-emerald-500/30">üñ•Ô∏è</div>
                <span class="text-[10px] uppercase tracking-tighter">Presentar</span>
            </button>
        </footer>
    </div>

    <script>
        let peer, localStream, roomCode, currentConn;
        let isMicOpen = true;
        let isCamOpen = true;

        // Auto-completar c√≥digo si viene en la URL
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) document.getElementById('roomCode').value = urlParams.get('room');
        }

        async function startApp() {
            roomCode = document.getElementById('roomCode').value.trim().toLowerCase();
            if(!roomCode) return alert("Introduce un c√≥digo");

            document.getElementById('login').classList.add('hidden');
            document.getElementById('room').classList.remove('hidden');
            document.getElementById('displayCode').innerText = roomCode;

            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('localVideo').srcObject = localStream;

            // ID √∫nico basado en el c√≥digo para evitar colisiones globales
            peer = new Peer('st-room-' + roomCode);

            peer.on('open', id => {
                // Intentar conectar con otros (L√≥gica simple: todos intentan llamar a la sala)
                // En PeerJS avanzado usar√≠amos un servidor de se√±alizaci√≥n, pero esto sirve para 1:1 directo.
                console.log("Conectado con ID:", id);
            });

            peer.on('call', call => {
                call.answer(localStream);
                call.on('stream', remoteStream => addRemoteVideo(remoteStream, call.peer));
            });

            peer.on('connection', conn => {
                currentConn = conn;
                conn.on('data', data => receiveMessage(data));
            });
        }

        function addRemoteVideo(stream, peerId) {
            if(document.getElementById(peerId)) return;
            const container = document.createElement('div');
            container.id = peerId;
            container.className = "relative rounded-2xl overflow-hidden bg-slate-900 border border-blue-500/30 remote-video shadow-xl shadow-blue-500/5";
            container.innerHTML = `<video autoplay playsinline class="w-full h-full object-cover"></video>
                                   <div class="absolute bottom-4 left-4 bg-blue-600/60 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-white">Invitado</div>`;
            container.querySelector('video').srcObject = stream;
            document.getElementById('video-grid').append(container);
        }

        // --- FUNCIONES DE CONTROL ---
        function toggleMic() {
            isMicOpen = !isMicOpen;
            localStream.getAudioTracks()[0].enabled = isMicOpen;
            document.getElementById('btnMic').querySelector('div').classList.toggle('bg-red-600', !isMicOpen);
        }

        function toggleCam() {
            isCamOpen = !isCamOpen;
            localStream.getVideoTracks()[0].enabled = isCamOpen;
            document.getElementById('btnCam').querySelector('div').classList.toggle('bg-red-600', !isCamOpen);
        }

        function copyInvite() {
            const url = window.location.origin + window.location.pathname + '?room=' + roomCode;
            navigator.clipboard.writeText(url);
            alert("¬°Link de invitaci√≥n copiado! P√°salo a tus compa√±eros.");
        }

        // --- CHAT CIFRADO ---
        function sendMessage() {
            const input = document.getElementById('chatInput');
            if(!input.value) return;

            const encrypted = CryptoJS.AES.encrypt(input.value, roomCode).toString();
            
            // Mostrar en mi pantalla
            displayMessage(input.value, 'T√∫', 'text-blue-400');
            
            // Enviar a los dem√°s (en esta versi√≥n b√°sica enviamos al peer conectado)
            if(currentConn) currentConn.send(encrypted);
            input.value = '';
        }

        function receiveMessage(data) {
            const bytes = CryptoJS.AES.decrypt(data, roomCode);
            const decrypted = bytes.toString(CryptoJS.enc.Utf8);
            displayMessage(decrypted, 'Invitado', 'text-emerald-400');
        }

        function displayMessage(text, sender, colorClass) {
            const div = document.createElement('div');
            div.className = "bg-slate-800/50 p-3 rounded-xl border border-slate-700/50";
            div.innerHTML = `<span class="font-bold text-[10px] uppercase ${colorClass}">${sender}</span><p class="mt-1">${text}</p>`;
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function shareScreen() {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({video: true});
            document.getElementById('localVideo').srcObject = screenStream;
            // Aqu√≠ se deber√≠a a√±adir l√≥gica para reemplazar el track en las llamadas activas
        }
    </script>
</body>
</html>